<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COCKPIT DE COMBAT</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --dark-light: #1e293b;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --white: #ffffff;
            --border: #334155;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #1a1a2e 50%, #16213e 100%);
            color: var(--white);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* HEADER MISSION */
        .mission-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .mission-header.zone-rouge {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .mission-title {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .mission-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-label {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--white);
        }

        .stat-value.danger {
            color: var(--danger);
        }

        .stat-value.success {
            color: var(--success);
        }

        /* LAYOUT PRINCIPAL */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
        }

        .panel {
            background: var(--dark-light);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-2px);
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: var(--white);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--primary);
            border-radius: 2px;
        }

        /* CHECKLIST COMPACTE */
        .checklist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin: 0.5rem 0;
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checklist-item:hover {
            border-color: var(--primary);
            transform: translateX(5px);
        }

        .checklist-item.completed {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            border-color: var(--success);
        }

        .checklist-item.active {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
            border-color: var(--warning);
        }

        .check-text {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .check-time {
            font-size: 0.75rem;
            color: var(--gray-light);
            margin-top: 0.25rem;
        }

        .check-status {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .check-selector {
            background: var(--primary);
            color: var(--white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 1rem;
            width: 100%;
        }

        /* FORMULAIRE CHECK ACTIF */
        .active-check {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            color: var(--white);
            max-height: 600px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--white);
            font-size: 0.9rem;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.6rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: var(--white);
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }

        .form-textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            background: linear-gradient(135deg, var(--white) 0%, #f1f5f9 100%);
            color: var(--primary);
            border: none;
            padding: 0.75rem 2rem;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* COMMUNICATION COMPACTE */
        .communication {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .feedback-coach, .mission-journal {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--dark);
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .feedback-coach {
            border-left: 4px solid var(--warning);
        }

        .mission-journal {
            border-left: 4px solid var(--primary);
        }

        .message {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--dark-light);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .message-time {
            font-size: 0.7rem;
            color: var(--gray-light);
            margin-bottom: 0.25rem;
        }

        .message-content {
            font-size: 0.8rem;
            line-height: 1.4;
        }

        /* GRAPHIQUES */
        .charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .chart-item {
            background: var(--dark);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 1rem;
            text-align: center;
            height: 200px;
        }

        .chart-title {
            font-size: 0.8rem;
            color: var(--gray-light);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .chart-canvas {
            width: 100% !important;
            height: 150px !important;
        }

        /* BILAN HEBDOMADAIRE */
        .weekly-review {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .weekly-review.show {
            display: flex;
        }

        .review-content {
            background: var(--dark-light);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 2rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .file-upload:hover {
            border-color: var(--primary);
        }

        .file-upload input {
            display: none;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .mission-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .communication {
                grid-template-columns: 1fr;
            }
            
            .mission-title {
                font-size: 2rem;
            }
        }

        /* ANIMATIONS */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden {
            display: none;
        }

        /* SCROLLBAR CUSTOM */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER MISSION -->
        <div class="mission-header fade-in" id="missionHeader">
            <h1 class="mission-title">🎯 COCKPIT DE COMBAT</h1>
            <div class="mission-stats">
                <div class="stat-card">
                    <div class="stat-label">📅 PROGRESSION</div>
                    <div class="stat-value" id="dayProgress">JOUR 1/90</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">⚡ DISCIPLINE</div>
                    <div class="stat-value success" id="disciplineStatus">CONFORMITÉ PARFAITE</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">🔥 CHALLENGE ACTIF</div>
                    <div class="stat-value" id="activeChallenge">DOUCHE FROIDE</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">📊 CONFORMITÉ 7J</div>
                    <div class="stat-value success" id="weeklyCompliance">100%</div>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <!-- COLONNE 1: CHECKLIST + CHECK ACTIF -->
            <div>
                <div class="panel fade-in">
                    <div class="panel-title">✅ CHECKLIST QUOTIDIENNE</div>
                    <div id="dailyChecklist">
                        <div class="checklist-item" data-check="mental" onclick="selectCheck('mental')">
                            <div>
                                <div class="check-text">🧠 MENTAL & PHYSIOLOGIE</div>
                                <div class="check-time">07:00 - 08:30</div>
                            </div>
                            <span class="check-status" id="status-mental">⏳</span>
                        </div>
                        <div class="checklist-item" data-check="cardio" onclick="selectCheck('cardio')">
                            <div>
                                <div class="check-text">🏃 CARDIO & POIDS</div>
                                <div class="check-time">08:30 - 13:00</div>
                            </div>
                            <span class="check-status" id="status-cardio">⏳</span>
                        </div>
                        <div class="checklist-item" data-check="muscu" onclick="selectCheck('muscu')">
                            <div>
                                <div class="check-text">💪 MUSCU & DÉPASSEMENT</div>
                                <div class="check-time">13:00 - 20:00</div>
                            </div>
                            <span class="check-status" id="status-muscu">⏳</span>
                        </div>
                        <div class="checklist-item" data-check="bilan" onclick="selectCheck('bilan')">
                            <div>
                                <div class="check-text">📝 BILAN JOURNALIER</div>
                                <div class="check-time">20:00 - 07:00</div>
                            </div>
                            <span class="check-status" id="status-bilan">⏳</span>
                        </div>
                    </div>
                    <button class="check-selector" onclick="checkWeeklyReview()">📊 BILAN HEBDOMADAIRE</button>
                </div>

                <div class="panel active-check fade-in" id="activeCheckPanel">
                    <div class="panel-title" id="activeCheckTitle">🎯 CHECK ACTUEL</div>
                    <div id="activeCheckForm">
                        <div class="loading">Chargement du check...</div>
                    </div>
                </div>
            </div>

            <!-- COLONNE 2: COMMUNICATION -->
            <div class="communication fade-in">
                <div class="feedback-coach">
                    <div class="panel-title">🤖 COACH IA</div>
                    <div id="coachMessages">
                        <div class="message">
                            <div class="message-time">SYSTÈME INITIALISÉ</div>
                            <div class="message-content">Prêt pour la mission, soldat. Montre-moi de quoi tu es capable.</div>
                        </div>
                    </div>
                </div>

                <div class="mission-journal">
                    <div class="panel-title">📖 JOURNAL DE MISSION</div>
                    <div id="journalEntries">
                        <div class="message">
                            <div class="message-time">JOUR 1 - 00:00</div>
                            <div class="message-content">🚀 Début de mission. 90 jours pour devenir imbattable.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLONNE 3: GRAPHIQUES -->
            <div>
                <div class="panel fade-in">
                    <div class="panel-title">📊 PERFORMANCES</div>
                    <div class="charts">
                        <div class="chart-item">
                            <div class="chart-title">⚖️ ÉVOLUTION POIDS</div>
                            <canvas id="weightChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-item">
                            <div class="chart-title">😴 QUALITÉ SOMMEIL</div>
                            <canvas id="sleepChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-item">
                            <div class="chart-title">🏃 ACTIVITÉ SPORTIVE</div>
                            <canvas id="activityChart" class="chart-canvas"></canvas>
                        </div>
                        <div class="chart-item">
                            <div class="chart-title">🧠 RADAR MENTAL</div>
                            <canvas id="mentalChart" class="chart-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BILAN HEBDOMADAIRE -->
    <div class="weekly-review" id="weeklyReview">
        <div class="review-content">
            <div class="panel-title">📊 BILAN HEBDOMADAIRE</div>
            <form id="weeklyReviewForm" onsubmit="submitWeeklyReview(event)">
                <div class="form-group">
                    <label class="form-label">📸 Photos de progression (3 photos: face, profil, dos)</label>
                    <div class="file-upload" onclick="document.getElementById('photoUpload').click()">
                        <input type="file" id="photoUpload" name="photos" multiple accept="image/*" onchange="handlePhotoUpload(this)">
                        <div id="photoUploadText">📷 Cliquer pour ajouter les photos</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">📏 Mensurations</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <input type="number" class="form-input" name="taille" placeholder="Taille (cm)" step="0.1">
                        <input type="number" class="form-input" name="bras" placeholder="Bras (cm)" step="0.1">
                        <input type="number" class="form-input" name="cuisses" placeholder="Cuisses (cm)" step="0.1">
                        <input type="number" class="form-input" name="torse" placeholder="Torse (cm)" step="0.1">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">⚖️ Poids moyen de la semaine</label>
                    <input type="number" class="form-input" name="poids_moyen" step="0.1" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">🏃 Performance cardio moyenne (RPE 1-10)</label>
                    <select class="form-select" name="cardio_rpe" required>
                        <option value="">Sélectionner</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">🧠 Note mentale moyenne (1-10)</label>
                    <select class="form-select" name="mental_moyen" required>
                        <option value="">Sélectionner</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                        <option value="9">9</option>
                        <option value="10">10</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">📝 Synthèse personnelle de la semaine</label>
                    <textarea class="form-textarea" name="synthese" required placeholder="Bilan de tes progrès, difficultés, victoires..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn">✅ VALIDER BILAN</button>
                    <button type="button" class="btn" onclick="closeWeeklyReview()" style="background: var(--danger);">❌ FERMER</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // VARIABLES GLOBALES
        let currentDay = 1;
        let completedChecks = new Set();
        let currentCheckType = null;
        let dashboardData = {};
        let isOfflineMode = false;
        let charts = {};

        // CONFIGURATION - URL GOOGLE APPS SCRIPT
        const GOOGLE_WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbwUSLToys2G_18kN7w-rM_VPtzXWvRMht4HkknH6og4Q0BipS-Z5sB7BGDgv1C5KT8G/exec';
        
        const CHECK_TIMES = {
            'mental': { start: 7, end: 8.5, title: '🧠 MENTAL & PHYSIOLOGIE' },
            'cardio': { start: 8.5, end: 13, title: '🏃 CARDIO & POIDS' },
            'muscu': { start: 13, end: 20, title: '💪 MUSCU & DÉPASSEMENT' },
            'bilan': { start: 20, end: 24, title: '📝 BILAN JOURNALIER' }
        };

        // INITIALISATION
        function initDashboard() {
            console.log('🚀 Initialisation du dashboard...');
            
            loadDashboardData()
                .then(data => {
                    console.log('✅ Données reçues:', data);
                    isOfflineMode = false;
                    dashboardData = data;
                    updateDashboardDisplay();
                    renderCurrentCheck();
                    initCharts();
                    startFeedbackPolling();
                    checkWeeklyReviewTime();
                    showSuccess('✅ Connexion établie avec Google Sheets !');
                })
                .catch(error => {
                    console.warn('⚠️ Mode offline activé:', error);
                    isOfflineMode = true;
                    loadDefaultData();
                    showError('🔄 Mode offline - Données simulées');
                });
        }

        // CHARGEMENT DES DONNÉES
        async function loadDashboardData() {
            try {
                console.log('🔗 Tentative de connexion à:', GOOGLE_WEBAPP_URL + '?action=getDashboard');
                
                const response = await fetch(GOOGLE_WEBAPP_URL + '?action=getDashboard', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('📡 Réponse reçue:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Données parsées:', data);
                return data;
                
            } catch (error) {
                console.error('❌ Erreur loadDashboardData:', error);
                throw error;
            }
        }

        function loadDefaultData() {
            dashboardData = {
                currentDay: 1,
                disciplineStatus: 'CONFORMITÉ PARFAITE',
                activeChallenge: 'DOUCHE FROIDE',
                weeklyCompliance: 100,
                completedChecks: [],
                historyData: {
                    weight: [75.0, 74.8, 74.5, 74.2, 74.0, 73.8, 73.5],
                    sleep: [8, 7.5, 8.5, 7, 8, 8.5, 9],
                    activity: [7, 8, 6, 9, 7, 8, 8],
                    mental: [8, 7, 9, 8, 8, 9, 8]
                }
            };
            
            updateDashboardDisplay();
            renderCurrentCheck();
            initCharts();
            checkWeeklyReviewTime();
        }

        // MISE À JOUR DE L'AFFICHAGE
        function updateDashboardDisplay() {
            document.getElementById('dayProgress').textContent = `JOUR ${dashboardData.currentDay}/90`;
            
            // Calcul dynamique de la conformité
            const compliance = dashboardData.weeklyCompliance || calculateWeeklyCompliance();
            dashboardData.weeklyCompliance = compliance;
            
            // Gestion Zone Rouge
            if (compliance < 70) {
                dashboardData.disciplineStatus = '🔴 ZONE ROUGE';
                document.getElementById('missionHeader').classList.add('zone-rouge');
                document.getElementById('disciplineStatus').classList.add('danger');
                document.getElementById('disciplineStatus').classList.remove('success');
            } else {
                dashboardData.disciplineStatus = 'CONFORMITÉ PARFAITE';
                document.getElementById('missionHeader').classList.remove('zone-rouge');
                document.getElementById('disciplineStatus').classList.remove('danger');
                document.getElementById('disciplineStatus').classList.add('success');
            }
            
            document.getElementById('disciplineStatus').textContent = dashboardData.disciplineStatus;
            document.getElementById('activeChallenge').textContent = dashboardData.activeChallenge;
            document.getElementById('weeklyCompliance').textContent = dashboardData.weeklyCompliance + '%';

            if (dashboardData.completedChecks) {
                dashboardData.completedChecks.forEach(checkType => {
                    markCheckCompleted(checkType);
                });
            }
        }

        function calculateWeeklyCompliance() {
            // Simulation du calcul de conformité sur 7 jours
            const totalChecks = 7 * 4; // 7 jours * 4 checks par jour
            const completedChecksCount = Math.floor(Math.random() * 8) + 20; // Simulation
            return Math.round((completedChecksCount / totalChecks) * 100);
        }

        // SÉLECTION MANUELLE DE CHECK
        function selectCheck(checkType) {
            if (completedChecks.has(checkType)) {
                showError('❌ Ce check est déjà validé !');
                return;
            }
            
            currentCheckType = checkType;
            renderCurrentCheck();
            
            // Marquer comme actif
            document.querySelectorAll('.checklist-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-check="${checkType}"]`).classList.add('active');
        }

        // GESTION DES CHECKS
        function getCurrentCheckType() {
            const now = new Date();
            const currentHour = now.getHours() + (now.getMinutes() / 60);
            
            for (const [checkType, times] of Object.entries(CHECK_TIMES)) {
                if (currentHour >= times.start && currentHour < times.end) {
                    return checkType;
                }
            }
            
            if (currentHour < 7) return 'mental';
            if (currentHour < 8.5) return 'mental';
            if (currentHour < 13) return 'cardio';
            if (currentHour < 20) return 'muscu';
            return 'bilan';
        }

        function renderCurrentCheck() {
            if (!currentCheckType) {
                currentCheckType = getCurrentCheckType();
            }
            
            const checkInfo = CHECK_TIMES[currentCheckType];
            document.getElementById('activeCheckTitle').textContent = `🎯 ${checkInfo.title}`;
            
            const formHtml = generateCheckForm(currentCheckType);
            document.getElementById('activeCheckForm').innerHTML = formHtml;
        }

        function generateCheckForm(checkType) {
            if (completedChecks.has(checkType)) {
                return `
                    <div style="background: var(--success); padding: 1rem; border-radius: 8px; text-align: center;">
                        ✅ Check ${checkType.toUpperCase()} déjà validé !
                    </div>
                `;
            }

            switch (checkType) {
                case 'mental':
                    return `
                        <form id="checkForm" onsubmit="submitCheck(event)">
                            <div class="form-group">
                                <label class="form-label">🧠 Ce matin, t'as la tête comment ?</label>
                                <textarea class="form-textarea" name="mental_state" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">⏰ Heures de sommeil</label>
                                <input type="number" class="form-input" name="sleep_hours" step="0.5" min="0" max="12" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">😴 Qualité du sommeil (1-10)</label>
                                <select class="form-select" name="sleep_quality" required>
                                    <option value="">Sélectionner</option>
                                    ${generateOptions(1, 10)}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">🔋 Récupération nerveuse (1-10)</label>
                                <select class="form-select" name="recovery_quality" required>
                                    <option value="">Sélectionner</option>
                                    ${generateOptions(1, 10)}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">🎯 Objectif #1 de ta journée</label>
                                <input type="text" class="form-input" name="daily_objective" required>
                            </div>
                            <button type="submit" class="btn">✅ VALIDER CHECK</button>
                        </form>
                    `;
                    
                case 'cardio':
                    return `
                        <form id="checkForm" onsubmit="submitCheck(event)">
                            <div class="form-group">
                                <label class="form-label">🏃 T'as couru ce matin ?</label>
                                <select class="form-select" name="cardio_done" required onchange="toggleCardioDetails(this.value)">
                                    <option value="">Sélectionner</option>
                                    <option value="oui">Oui</option>
                                    <option value="non">Non</option>
                                </select>
                            </div>
                            <div id="cardioDetails" class="hidden">
                                <div class="form-group">
                                    <label class="form-label">📏 Combien de km ?</label>
                                    <input type="number" class="form-input" name="cardio_distance" step="0.1" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">⏱️ Temps (minutes)</label>
                                    <input type="number" class="form-input" name="cardio_time" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">💪 RPE (1-10)</label>
                                    <select class="form-select" name="cardio_rpe">
                                        <option value="">Sélectionner</option>
                                        ${generateOptions(1, 10)}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">⚖️ Poids (kg)</label>
                                <input type="number" class="form-input" name="weight" step="0.1" min="0" required>
                            </div>
                            <button type="submit" class="btn">✅ VALIDER CHECK</button>
                        </form>
                    `;
                    
                case 'muscu':
                    return `
                        <form id="checkForm" onsubmit="submitCheck(event)">
                            <div class="form-group">
                                <label class="form-label">💪 Muscu faite ?</label>
                                <select class="form-select" name="muscu_done" required onchange="toggleMuscuDetails(this.value)">
                                    <option value="">Sélectionner</option>
                                    <option value="oui">Oui</option>
                                    <option value="non">Non</option>
                                </select>
                            </div>
                            <div id="muscuDetails" class="hidden">
                                <div class="form-group">
                                    <label class="form-label">⏱️ Durée (min)</label>
                                    <input type="number" class="form-input" name="muscu_duration" min="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">🔥 Qualité</label>
                                    <select class="form-select" name="muscu_quality">
                                        <option value="">Sélectionner</option>
                                        <option value="fire">🔥 Excellente</option>
                                        <option value="moyenne">👍 Moyenne</option>
                                        <option value="shit">💩 À chier</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">💪 RPE (1-10)</label>
                                    <select class="form-select" name="muscu_rpe">
                                        <option value="">Sélectionner</option>
                                        ${generateOptions(1, 10)}
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">🚀 Action de dépassement</label>
                                <textarea class="form-textarea" name="challenge_action" required></textarea>
                            </div>
                            <button type="submit" class="btn">✅ VALIDER CHECK</button>
                        </form>
                    `;
                    
                case 'bilan':
                    return `
                        <form id="checkForm" onsubmit="submitCheck(event)">
                            <div class="form-group">
                                <label class="form-label">🥗 Nutrition OK ?</label>
                                <select class="form-select" name="nutrition_ok" required>
                                    <option value="">Sélectionner</option>
                                    <option value="oui">Oui</option>
                                    <option value="non">Non</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">😊 Émotion dominante</label>
                                <input type="text" class="form-input" name="dominant_emotion" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">⭐ Note journée (1-10)</label>
                                <select class="form-select" name="day_rating" required>
                                    <option value="">Sélectionner</option>
                                    ${generateOptions(1, 10)}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">💭 Justification</label>
                                <textarea class="form-textarea" name="day_justification" required></textarea>
                            </div>
                            <div class="form-group">
                                <label class="form-label">💼 Action business</label>
                                <textarea class="form-textarea" name="business_action" required></textarea>
                            </div>
                            <button type="submit" class="btn">✅ VALIDER CHECK</button>
                        </form>
                    `;
            }
        }

        function generateOptions(start, end) {
            let options = '';
            for (let i = start; i <= end; i++) {
                options += `<option value="${i}">${i}</option>`;
            }
            return options;
        }

        // FONCTIONS UTILITAIRES
        function toggleCardioDetails(value) {
            const details = document.getElementById('cardioDetails');
            if (value === 'oui') {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
        }

        function toggleMuscuDetails(value) {
            const details = document.getElementById('muscuDetails');
            if (value === 'oui') {
                details.classList.remove('hidden');
            } else {
                details.classList.add('hidden');
            }
        }

        // SOUMISSION DES DONNÉES
        async function submitCheck(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const answers = {};
            
            for (let [key, value] of formData.entries()) {
                answers[key] = value;
            }
            
            const payload = {
                checkType: currentCheckType,
                timestamp: new Date().toISOString(),
                answers: answers
            };
            
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = '⏳ ENVOI...';
            
            try {
                if (isOfflineMode) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    simulateDataProcessing(payload);
                } else {
                    await sendData(payload);
                }
                
                markCheckCompleted(currentCheckType);
                showSuccess('✅ Check validé !');
                addJournalEntry(`Check ${currentCheckType.toUpperCase()} validé`);
                updateDashboardDisplay();
                updateCharts();
                
                setTimeout(() => {
                    currentCheckType = null;
                    renderCurrentCheck();
                }, 2000);
                
            } catch (error) {
                showError('❌ Erreur: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = '✅ VALIDER CHECK';
            }
        }

        function simulateDataProcessing(payload) {
            console.log('📊 Données simulées:', payload);
            
            const responses = [
                "Excellent ! Continue comme ça.",
                "Bien joué, reste focus.",
                "Performance solide, prêt pour la suite ?",
                "Discipline exemplaire !"
            ];
            
            setTimeout(() => {
                addCoachMessage(responses[Math.floor(Math.random() * responses.length)]);
            }, 2000);
        }

        async function sendData(payload) {
            try {
                console.log('📤 Envoi des données:', payload);
                
                const response = await fetch(GOOGLE_WEBAPP_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                console.log('📡 Réponse POST:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('✅ Résultat:', result);
                return result;
                
            } catch (error) {
                console.error('❌ Erreur sendData:', error);
                throw error;
            }
        }

        function markCheckCompleted(checkType) {
            completedChecks.add(checkType);
            
            const statusElement = document.getElementById(`status-${checkType}`);
            const checklistItem = document.querySelector(`[data-check="${checkType}"]`);
            
            if (statusElement) statusElement.textContent = '✅';
            if (checklistItem) {
                checklistItem.classList.add('completed');
                checklistItem.classList.remove('active');
            }
        }

        // GRAPHIQUES CHART.JS
        function initCharts() {
            // Graphique Poids
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            charts.weight = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: ['J-6', 'J-5', 'J-4', 'J-3', 'J-2', 'J-1', 'Aujourd\'hui'],
                    datasets: [{
                        label: 'Poids (kg)',
                        data: dashboardData.historyData?.weight || [75, 74.8, 74.5, 74.2, 74.0, 73.8, 73.5],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });

            // Graphique Sommeil
            const sleepCtx = document.getElementById('sleepChart').getContext('2d');
            charts.sleep = new Chart(sleepCtx, {
                type: 'bar',
                data: {
                    labels: ['J-6', 'J-5', 'J-4', 'J-3', 'J-2', 'J-1', 'Aujourd\'hui'],
                    datasets: [{
                        label: 'Sommeil (h)',
                        data: dashboardData.historyData?.sleep || [8, 7.5, 8.5, 7, 8, 8.5, 9],
                        backgroundColor: '#6366f1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });

            // Graphique Activité
            const activityCtx = document.getElementById('activityChart').getContext('2d');
            charts.activity = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['J-6', 'J-5', 'J-4', 'J-3', 'J-2', 'J-1', 'Aujourd\'hui'],
                    datasets: [{
                        label: 'Activité',
                        data: dashboardData.historyData?.activity || [7, 8, 6, 9, 7, 8, 8],
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { display: false }
                    }
                }
            });

            // Radar Mental
            const mentalCtx = document.getElementById('mentalChart').getContext('2d');
            charts.mental = new Chart(mentalCtx, {
                type: 'radar',
                data: {
                    labels: ['Énergie', 'Focus', 'Motivation', 'Récupération', 'Discipline'],
                    datasets: [{
                        label: 'Mental',
                        data: [8, 9, 7, 8, 9],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        pointBackgroundColor: '#ef4444'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 10,
                            display: false
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Mise à jour des graphiques avec nouvelles données
            if (charts.weight && dashboardData.historyData?.weight) {
                charts.weight.data.datasets[0].data = dashboardData.historyData.weight;
                charts.weight.update();
            }
        }

        // BILAN HEBDOMADAIRE
        function checkWeeklyReviewTime() {
            const now = new Date();
            const isDimanche = now.getDay() === 0; // 0 = Dimanche
            const currentHour = now.getHours();
            
            if (isDimanche && currentHour >= 18 && currentHour < 23) {
                document.querySelector('.check-selector').style.background = 'var(--danger)';
                document.querySelector('.check-selector').textContent = '🚨 BILAN HEBDO OBLIGATOIRE';
            }
        }

        function checkWeeklyReview() {
            const now = new Date();
            const isDimanche = now.getDay() === 0;
            const currentHour = now.getHours();
            
            if (isDimanche && currentHour >= 18 && currentHour < 23) {
                document.getElementById('weeklyReview').classList.add('show');
            } else {
                showError('❌ Le bilan hebdomadaire n\'est disponible que le dimanche de 18h à 23h');
            }
        }

        function closeWeeklyReview() {
            document.getElementById('weeklyReview').classList.remove('show');
        }

        function handlePhotoUpload(input) {
            const files = input.files;
            const text = document.getElementById('photoUploadText');
            
            if (files.length > 0) {
                text.textContent = `📷 ${files.length} photo(s) sélectionnée(s)`;
            } else {
                text.textContent = '📷 Cliquer pour ajouter les photos';
            }
        }

        async function submitWeeklyReview(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            
            // Traitement des photos (simulation)
            const photos = formData.get('photos');
            if (photos && photos.length > 0) {
                console.log('📸 Photos à traiter:', photos);
            }
            
            const payload = {
                type: 'weekly_review',
                timestamp: new Date().toISOString(),
                data: Object.fromEntries(formData.entries())
            };
            
            try {
                if (isOfflineMode) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    console.log('📊 Bilan hebdomadaire simulé:', payload);
                } else {
                    await sendData(payload);
                }
                
                showSuccess('✅ Bilan hebdomadaire validé !');
                addJournalEntry('📊 Bilan hebdomadaire complété');
                closeWeeklyReview();
                
            } catch (error) {
                showError('❌ Erreur lors de l\'envoi du bilan: ' + error.message);
            }
        }

        // FEEDBACK IA
        function startFeedbackPolling() {
            if (!isOfflineMode) {
                setInterval(fetchFeedback, 30000);
            }
        }

        async function fetchFeedback() {
            try {
                const response = await fetch(GOOGLE_WEBAPP_URL + '?action=getFeedback');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.messages?.length > 0) {
                    data.messages.forEach(msg => addCoachMessage(msg.content, msg.timestamp));
                }
            } catch (error) {
                console.error('❌ Erreur fetchFeedback:', error);
            }
        }

        function addCoachMessage(content, timestamp = null) {
            const container = document.getElementById('coachMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message fade-in';
            messageElement.innerHTML = `
                <div class="message-time">${formatTime(timestamp || new Date())}</div>
                <div class="message-content">🤖 ${content}</div>
            `;
            container.appendChild(messageElement);
            container.scrollTop = container.scrollHeight;
        }

        function addJournalEntry(content, timestamp = null) {
            const container = document.getElementById('journalEntries');
            const entryElement = document.createElement('div');
            entryElement.className = 'message fade-in';
            entryElement.innerHTML = `
                <div class="message-time">${formatTime(timestamp || new Date())}</div>
                <div class="message-content">📝 ${content}</div>
            `;
            container.appendChild(entryElement);
            container.scrollTop = container.scrollHeight;
        }

        // UTILITAIRES
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'background: var(--success); color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; animation: fadeIn 0.5s ease-in;';
            successDiv.textContent = message;
            
            const form = document.getElementById('activeCheckForm');
            form.insertBefore(successDiv, form.firstChild);
            
            setTimeout(() => successDiv.remove(), 3000);
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'background: var(--danger); color: white; padding: 1rem; border-radius: 8px; margin: 1rem 0; animation: fadeIn 0.5s ease-in;';
            errorDiv.textContent = message;
            
            const form = document.getElementById('activeCheckForm');
            form.insertBefore(errorDiv, form.firstChild);
            
            setTimeout(() => errorDiv.remove(), 5000);
        }

        // GESTION DES ERREURS GLOBALES
        window.addEventListener('error', function(event) {
            console.error('❌ Erreur JavaScript:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('❌ Promesse rejetée:', event.reason);
            event.preventDefault();
        });

        // DÉMARRAGE
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Démarrage du Cockpit de Combat...');
            initDashboard();
            setInterval(renderCurrentCheck, 60000);
            setInterval(checkWeeklyReviewTime, 3600000); // Vérifier chaque heure
        });
    </script>
</body>
</html>
